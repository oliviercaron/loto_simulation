name: Mise √† jour des donn√©es Loto

on:
  # Lancement manuel depuis l‚Äôonglet "Actions"
  workflow_dispatch:

  # Ex√©cution automatique tous les lundis √† 5h du matin (heure de Paris)
  # Note : le cron est en UTC, donc 5h Paris = 3h UTC en √©t√©
  schedule:
    - cron: '0 3 * * 1'

# Autorisations n√©cessaires pour pouvoir pousser des commits dans le d√©p√¥t
permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      # 1) T√©l√©charger le code du d√©p√¥t priv√©
      # GitHub fournit automatiquement un GITHUB_TOKEN pour √ßa,
      # donc pas besoin d‚Äôutiliser un PAT.
      - name: R√©cup√©rer le d√©p√¥t
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Historique minimal pour plus de rapidit√©

      # 2) T√©l√©charger et d√©compresser les donn√©es Loto depuis le site de la FDJ
      - name: T√©l√©charger et d√©zipper les donn√©es Loto
        shell: bash
        run: |
          PAGE_HISTORIQUE="https://www.fdj.fr/jeux-de-tirage/loto/historique"
          URL_TELECHARGEMENT=$(curl -s "$PAGE_HISTORIQUE" \
            | grep -o 'https://www\.sto\.api\.fdj\.fr/anonymous/service-draw-info/v3/documentations/[^"]*' \
            | head -n 1)
          if [ -z "$URL_TELECHARGEMENT" ]; then
            echo "ERREUR : lien de t√©l√©chargement introuvable." >&2
            exit 1
          fi
          echo "Lien trouv√© : $URL_TELECHARGEMENT"
          curl -L -o loto_new.zip "$URL_TELECHARGEMENT"
          unzip -o loto_new.zip

      # 3) Installer l‚Äôenvironnement R
      - name: Installer R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.2'

      # 4) Installer les d√©pendances R n√©cessaires
      - name: Installer les d√©pendances R
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          packages: |
            any::readr
            any::dplyr
            any::lubridate
          cache: true

      # 5) Lancer le script R qui combine les donn√©es
      - name: Ex√©cuter le script R
        run: Rscript combine_script.R

      # 6) Commiter et pousser les modifications si le fichier a chang√©
      - name: Commit et push si changement
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "üìä Chore: Mise √† jour des donn√©es Loto"
          file_pattern: 'loto_combined.csv'
          commit_user_name: "GitHub Actions Bot"
          commit_user_email: "actions@github.com"
