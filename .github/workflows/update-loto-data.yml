name: Mise √† jour des donn√©es Loto

on:
  # Permet de lancer ce workflow manuellement depuis l'onglet "Actions" de GitHub
  workflow_dispatch:

  # Ex√©cute le workflow automatiquement tous les lundis √† 5h du matin
  schedule:
    - cron: '0 5 * * 1'

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      # 1. R√©cup√®re le code de ton d√©p√¥t
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Scrape la page FDJ, t√©l√©charge et d√©zippe le fichier
      - name: Download and Unzip Loto Data
        run: |
          # URL de la page contenant le lien de t√©l√©chargement
          HISTORY_PAGE_URL="https://www.fdj.fr/jeux-de-tirage/loto/historique"

          # Trouve le lien de t√©l√©chargement du zip dans le code HTML de la page
          # et le stocke dans la variable DOWNLOAD_URL
          DOWNLOAD_URL=$(curl -s $HISTORY_PAGE_URL | grep -o 'https://www.sto.api.fdj.fr/anonymous/service-draw-info/v3/documentations/[^"]*')

          if [ -z "$DOWNLOAD_URL" ]; then
            echo "Erreur: Impossible de trouver le lien de t√©l√©chargement."
            exit 1
          fi

          echo "Lien trouv√© : $DOWNLOAD_URL"
          
          # T√©l√©charge le fichier zip
          curl -L -o loto_new.zip "$DOWNLOAD_URL"
          
          # D√©zippe le fichier (le -o √©crase les anciens fichiers avec le m√™me nom)
          unzip -o loto_new.zip
          echo "Fichier d√©zipp√© avec succ√®s."

      # 3. Met en place l'environnement R
      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.2' # ou 'latest'

      - name: Install R dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          packages:
            any::readr
            any::dplyr
            any::lubridate

      # 4. Ex√©cute le script R pour combiner les donn√©es
      - name: Run R script
        run: Rscript combine_script.R

      # 5. Sauvegarde les changements dans le d√©p√¥t si le fichier a √©t√© modifi√©
      - name: Commit and push if changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "üìä Chore: Mise √† jour des donn√©es Loto"
          file_pattern: 'loto_combined.csv'
          commit_user_name: "GitHub Actions Bot"
          commit_user_email: "actions@github.com"
